[tox]
envlist = {py36,py37,py38,pypy3}-{cov,nocov,diffcov,profile}, qa, docs
skip_missing_interpreters = True

[testenv]
commands =
    mkdir -p _dynamic
    python -c "import os,pprint; pprint.pprint(dict(os.environ), stream=open('_dynamic/ENV."{envname}"', 'wt'))"
    nocov: python -m nose2 -v {posargs}
    {cov,diffcov}: python -m coverage run {[coverage]rc} -m nose2
    {cov,diffcov}: python -m coverage combine {[coverage]rc}
    cov: python -m coverage html {[coverage]rc}
    cov: python -m coverage report -m {[coverage]rc} --fail-under=100
    diffcov: python -m coverage xml {[coverage]rc}
    diffcov: diff-cover coverage.xml --html-report diffcov.html
    diffcov: diff-cover coverage.xml --fail-under=100
    profile: python -m nose2 --profile {posargs}
    profile: mv _dynamic/cPROFILE _dynamic/cPROFILE.{envname}
whitelist_externals =
    mv
    mkdir
#sitepackages = True
usedevelop = True
deps =
    nose2
    flufl.testing
    {cov,diffcov}: coverage
    diffcov: diff_cover
setenv =
    cov: COVERAGE_PROCESS_START={[coverage]rcfile}
    cov: COVERAGE_OPTIONS="-p"
    cov: COVERAGE_FILE={toxinidir}/.coverage
    py36: INTERP=py36
    py37: INTERP=py37
    py38: INTERP=py38
    pypy3: INTERP=pypy3
    {nocov,profile}: PYTHONASYNCIODEBUG=1
    PLATFORM={env:PLATFORM:linux}
passenv =
    PYTHON*

[coverage]
rcfile = {toxinidir}/.coverage.ini
rc = --rcfile={[coverage]rcfile}

[testenv:qa]
basepython = python3
commands =
    python -m flake8 aiosmtpd
deps =
    flake8
    flufl.testing

[testenv:docs]
basepython = python3
commands =
    python setup.py build_sphinx
deps:
    sphinx

[flake8]
enable-extensions = U4
exclude = conf.py
hang-closing = True
jobs = 1
max-line-length = 79
ignore = E133, W503, W504
